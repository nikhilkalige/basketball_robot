#! /usr/bin/env python
from bbbot_robot.cmaes import setup_cmaes, run_cmaes, checkpoint_handle, generate_name, init_creator
from bbbot_robot.cmaes_hansen import hans_setup_cmaes, hans_run_cmaes
from bbbot_robot.evaluate import Evaluate, EvaluateHansen
import sys
import os
import rospy


cmaes_dump = "/home/nikhilkalige/workspace/asu/thesis/cmaes_dump"
NGEN = 1000
SIGMA = 1
DMP = 15
BAG_FILE = '/home/nikhilkalige/workspace/ros/devel_packages/bag_files/2016-05-15-15-20-40.bag'


def cmaes_deap(robot, location):
    # p = robot.get_initial_params()
    # robot.eval(p)

    init_creator()
    (population, start_gen, start_child, hof, logbook, cmaes, fitness) = checkpoint_handle(NGEN)
    # folder = '/home/lonewolf/workspace/asu/thesis/cmaes_dump/08_06_11_16_03'
    # pname = 'g00006'
    # # cname = 'g00003c14'
    # cname = False
    # (population, start_gen, start_child, hof, logbook, cmaes, fitness) = checkpoint_handle(NGEN, True, folder, pname, cname)

    rospy.loginfo("Finished checpoint handle")
    (toolbox, cmaes, stats) = setup_cmaes(NGEN, SIGMA, robot.get_initial_params(), cmaes, robot.eval)

    run_cmaes([toolbox, cmaes, hof, stats, logbook, start_gen, start_child, fitness, population],
              NGEN, location, False)


# tbest = [  1.8284905472974833, 3.8234043731516563, 4.4687962002694936, 5.9093902481269245, 6.3621251606771105, 7.1364029283308801, 3.7337401286852314, 5.8413234871325308, 3.5789461685557429, 17.688036571316168, 16.531423892854548, 15.931914016162819, 19.690284533171553, 15.524394584369295, 19.381155271817349, 18.509201347466515, 17.555922115366588, 18.959110688528355, 20.531785886779485, 18.389557344497362, 23.003878789659257, 18.145402218726701, 20.743144623815809, 21.402787391827779, 18.130823505093915, 17.401271236647492, 17.324411851191957, 16.950671791381737, 15.724880455457042, 16.89560499566506, 16.038575485729545, 14.860801025435059, 18.048539319969887, 15.983098143750244, 19.637839665936362, 19.895032080005606, 19.571717513041257, 22.128638479122625, 21.36623151735505, 16.960825149789677, 16.461194485926239, 17.313116268705937, 15.438493399683432, 15.389238189216485, 14.50499980753891, 15.903906490062029, 16.451954566493306, 18.473493479123363, 17.080038548510114, 18.886396942571647, 20.884414857503216, 20.343970031654514, 19.622613628033911, 19.193384997149437]
# tbest = [4.23354349927, 2.78612441432, 3.41502746257, 6.50512168454, 6.93043327403, 5.83752987632, 1.84169854245, 6.39873951096, 4.54466888997, 20.506161979, 13.9334278363, 15.7807906124, 18.5670100512, 16.6781799239, 15.7231624266, 14.5569795012, 16.9556759918, 18.0654497238, 18.8688678214, 16.2159575913, 19.7183319288, 23.3267344858, 20.1276883694, 20.2041271246, 15.4339778931, 19.3517324599, 17.0354219686, 14.4275671309, 16.7944321386, 18.5671846426, 13.8080895589, 18.0429147514, 14.7243376636, 23.6991439499, 19.0410365267, 21.9578654107, 19.3999247854, 22.913758113, 19.2694612845, 12.7450475374, 16.2011385488, 19.8189031611, 15.3218472438, 22.5460517043, 14.9607541424, 11.3153885784, 19.907063382, 22.2563351066, 17.4335030205, 16.4485648978, 23.4525139603, 23.2387219024, 20.1254377895, 18.3922365029]
# tbest = [2.49460753438,  4.65707198733,  3.04660247438,  5.96902329557,  7.66901536361,  6.82442135162,  2.23502308883,  5.4101194398,  3.02102688948,  13.1637206195,  17.8105368598,  12.2789528592,  18.2948161727,  17.1321181374,  13.3285465515,  16.1416352735,  16.8765009811,  16.4800802634,  17.766395777,  16.6911985657,  18.3938936333,  22.067056289,  21.6881864693,  17.7606494548,  16.6869810663,  15.3394079893,  16.423005542,  16.0898748547,  15.9408672587,  15.7115649708,  17.1524274934,  12.6427133068,  18.8453466764,  18.6567339345,  17.2230433535,  20.2874943199,  23.9246120693,  18.2346440177,  19.4195462464,  19.2099473018,  14.2119149126,  17.0508680725,  13.4748378825,  19.8123291611,  14.9894410884,  20.1927178196,  14.6374960796,  18.0674628048,  16.0189107431,  17.8789911975,  20.024488571,  21.8478071618,  21.7690663633,  19.9269855567]
tbest = [0.891960509687,  3.45447648632,  3.18072439128,  5.96856522206,  7.52047698755,  6.55891945451,  2.69534872802,  5.91168764394,  2.18710631329,  13.9574375579,  17.5475616316,  11.8165793497,  18.2433886066,  17.7447001557,  13.3659246484,  15.4567865647,  18.275434157,  17.169230542,  17.1419001235,  16.4142275621,  19.5793561556,  22.3716565473,  21.2669584732,  18.8199171475,  16.7926438462,  15.1503726335,  14.8982610365,  14.4198551641,  15.5137355377,  15.708741635,  16.8355144051,  13.5493704653,  18.1846197229,  19.2242894535,  17.2987904017,  20.4960039226,  24.0950046899,  19.4478378604,  20.8402286633,  18.7449708349,  14.5318407731,  15.6221962861,  14.4215557221,  19.8702572374,  17.1166633681,  21.5675096998,  13.5069988761,  18.4948683727,  17.3303712963,  18.1279257792,  19.8514504378,  20.9917777794,  20.8165001897,  19.7527252765]
tbest = [1.67222658683, 3.85562555984, 3.18674669882, 6.23744883371, 6.54063234106, 6.28676941798, 2.70363229117, 5.74205405695, 2.67412077055, 13.7679938583, 18.3201377226, 11.868851604, 18.2183791606, 18.3835423119, 13.7684971203, 15.5382080076, 17.6957762345, 16.7434321598, 17.6857267722, 16.8525763052, 19.0216351325, 21.6237925521, 21.577643756, 17.883286389, 16.9234315801, 15.2372564397, 15.6025071138, 15.2892098471, 15.7349346409, 16.086817437, 17.2919810246, 12.5558231116, 19.1357694814, 19.356237906, 17.6147565019, 20.0716614571, 23.4408734253, 19.556872152, 20.1652476071, 19.1105162601, 14.8566783427, 16.7930540863, 14.4177255684, 20.2432204218, 16.0451700055, 20.2758790018, 13.1775877128, 18.0908082822, 17.1170904878, 18.0455640783, 19.4593268877, 21.5879806897, 21.9921692503, 19.5580190039]
tbest = [1.5374207637, 3.43943638598, 3.13010321953, 6.19306021479, 6.46926119125, 6.34453288154, 2.78110373243, 5.67706033659, 2.66277908908, 13.5728494856, 18.108147248, 11.8971139046, 18.3649853389, 17.9932311811, 14.0403807067, 15.60544154, 17.9142654267, 15.9520941224, 17.3282748712, 17.1810470396, 19.1007450029, 21.607843753, 21.911673995, 18.177040506, 17.2106930849, 14.6898641593, 15.7701913693, 15.1335034874, 15.8029156906, 16.0214164608, 16.7494472548, 12.6787005363, 19.0874849577, 18.8839411867, 17.3026440391, 19.9288486752, 23.0989868093, 19.4034729325, 19.7033459818, 19.1700738697, 14.4302697227, 16.305670859, 14.5281178801, 20.141831242, 15.8454107788, 20.2213524716, 12.6891850938, 18.6967380549, 16.6244988912, 17.5003959717, 19.4073805672, 21.8867099938, 21.924803371, 19.3983730162]

def cmaes_hansen(robot, location):
    cmaes = hans_setup_cmaes(SIGMA, robot.get_initial_params(), constraint_func=True)

    # p = robot.get_initial_params()
    robot.eval(tbest)
    return

    # filename = '/home/nikhilkalige/workspace/asu/thesis/cmaes_dump/31_08_17_26_18/cma_00027.pkl'
    # cmaes = hans_setup_cmaes(SIGMA, robot.get_initial_params(), constraint_func=True, checkpoint=True, filename=filename)
    # robot.set_evals(cmaes.countevals)

    hans_run_cmaes(cmaes, robot.eval, location)


if __name__ == '__main__':
    rospy.init_node('bot')
    # robot = Evaluate(DMP, BAG_FILE)
    # robot = EvaluateHansen(DMP, BAG_FILE)
    robot = EvaluateHansen(DMP, BAG_FILE, plot=True, basket=True)
    rospy.loginfo("Finished initialization")

    location = generate_name(cmaes_dump)
    rospy.loginfo("Location: {}".format(location))

    # cmaes_deap(robot, location)
    cmaes_hansen(robot, location)

    robot.track.kill()
    rospy.loginfo("Finished execution of cmaes")
